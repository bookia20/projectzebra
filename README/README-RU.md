# Эталонная бессерверная архитектура: интернет-приложения

Эта эталонная бессерверная архитектура позволяет понять, как создавать динамические интернет-приложения, используя [AWS Lambda](http://aws.amazon.com/lambda/) и Amazon API Gateway для аутентификации и обработки запросов API.

Объединив AWS Lambda с другими сервисами AWS, разработчики могут создавать эффективные интернет-приложения, которые автоматически масштабируются и выполняются с высоким уровнем доступности в нескольких центрах обработки данных. При этом не нужно тратить время на реализацию масштабирования, резервного копирования и избыточности.

В этом примере с помощью сервисов AWS Lambda и Amazon API Gateway создается динамическое приложение для голосования, которое получает голоса по SMS, передает данные в Amazon DynamoDB и отображает результаты в реальном времени с помощью Amazon Simple Storage Service (Amazon S3).

Архитектуру, описанную на этой [схеме](https://s3.amazonaws.com/awslambda-reference-architectures/web-app/lambda-refarch-webapp.pdf), можно создать с помощью шаблона AWS CloudFormation.

[Шаблон](https://s3.amazonaws.com/awslambda-reference-architectures/web-app/lambda_webapp.template) выполняет следующие действия:

- создает корзину S3 с именем &lt;S3BucketName\> для размещения интернет-приложения;
- создает таблицу DynamoDB с именем VoteApp для хранения голосов;
- создает таблицу DynamoDB с именем VoteAppAggregates для хранения итогов голосования;
- создает функцию Lambda, позволяющую приложению получать голоса;
- создает функцию Lambda, позволяющую приложению обрабатывать голоса;
- создает роль и политику AWS Identity and Access Management (IAM), которые позволяют функциям Lambda записывать данные в журналы Amazon CloudWatch и извлекать данные из таблиц DynamoDB.

## Динамическая панель управления

Сервисы и ресурсы, настроенные шаблоном AWS CloudFormation, можно протестировать на HTML-странице index.html, которая использует файлы HTML, JavaScript и CSS, размещенные в этом репозитории. Вы можете скопировать их в корзину S3, созданную скриптом AWS CloudFormation.

## Инструкции
**Важно!** Предоставленный шаблон CloudFormation извлекает код Lambda из корзины в регионе us-east-1. Чтобы запустить пример в другом регионе, измените шаблон и загрузите код Lambda в корзину в этом регионе. 

В этом примере показано, как получать голоса от пользователей по SMS по номеру телефона. Для копирования системы на основе этой архитектуры необходимо зарегистрировать номер телефона у стороннего поставщика, например [Twilio](http://twilio.com). Подробные сведения см. в [нашей публикации](https://medium.com/aws-activate-startup-blog/building-dynamic-dashboards-using-aws-lambda-and-amazon-dynamodb-streams-part-ii-b2d883bebde5) в [AWS Startup Collection at Medium](https://medium.com/aws-activate-startup-blog).

Шаг 1. Создайте стек AWS CloudFormation с помощью [шаблона](https://s3.amazonaws.com/awslambda-reference-architectures/web-app/lambda_webapp.template), указав имя стека строчными буквами.

Шаг 2. Откройте [панель управления API Gateway](https://console.aws.amazon.com/apigateway/home) в вашем аккаунте AWS и создайте ресурс с адресом «/vote». Назначьте метод POST с функцией Lambda Function типа «Integration Request» и укажите функцию Lambda, созданную скриптом AWS CloudFormation, которая получает голоса от стороннего сервиса (в этом пример – Twilio).

В разделе «Mapping Templates» задайте для параметра «Content-Type» значение «application/x-www-form-urlencoded» и добавьте [этот шаблон соответствия](apigateway-mappingtemplate.txt).

Шаг 3. Откройте [панель управления Amazon Cognito](https://console.aws.amazon.com/cognito/home) и создайте пул удостоверений, предоставляющий доступ к не прошедшим аутентификацию удостоверениям. Измените документ политики, чтобы разрешить доступ для чтения к таблице DynamoDB, созданной скриптом AWS CloudFormation, описанным выше. Это позволит не прошедшим аутентификацию пользователям извлекать данные из таблицы итогов голосования в DynamoDB. В Amazon Cognito представлен пример кода для платформы JavaScript. Запомните ID пула удостоверений, он потребуется на шаге 4.

Шаг 4. Скопируйте файлы HTML, CSS и JS из этого репозитория в статическую корзину S3, созданную для хранения вашей панели управления. Вам потребуется открыть файл refresh.js и заменить значения параметров «region» и «identity-pool-id» по умолчанию на собственные значения.

Поздравляем! Вы получили работающий пример эталонной архитектуры. Вы сможете получать голоса, настраивать таблицу DynamoDB для обработки различного объема входящего трафика и отслеживать результаты на панели управления в реальном времени.

## Примечания

Скрипт AWS CloudFormation создает две таблицы DynamoDB. Хотя вы можете указать настройки чтения и записи в скрипте AWS CloudFormation, вы не сможете задать имена таблиц в нем. Это связано с тем, что в коде JavaScript, получающем и обрабатывающем голоса, заранее необходимо указать имена этих таблиц (_VoteApp_ и _VoteAppAggregates_). Если вы хотите изменить имена таблиц DynamoDB, поменяйте их в файлах JavaScript в [коде обработки](/lambda-functions/aggregate-votes/) и [коде получения](/lambda-functions/receive-vote/).

## Очистка

Чтобы удалить все автоматически созданные ресурсы, удалите стек AWS CloudFormation. Вам потребуется вручную удалить адрес API Gateway и пул удостоверений Amazon Cognito.

Примечание. Перед удалением корзины S3 необходимо удалить все файлы в ней.

## Лицензия

Данная эталонная архитектура лицензирована в соответствии с лицензией Apache 2.0.
